# 核心接口和数据结构定义文档

AI-Commit TUI项目统一的核心接口、数据结构和类型定义

## 1. 文件状态和Git相关类型

### 1.1 Git文件状态定义

```rust
use serde::{Serialize, Deserialize};
use std::path::PathBuf;
use std::time::SystemTime;

/// Git文件状态枚举
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub enum FileStatus {
    /// 未跟踪的新文件
    Untracked,
    /// 已添加到暂存区
    Added,
    /// 已修改
    Modified,
    /// 已删除
    Deleted,
    /// 已重命名
    Renamed,
    /// 类型变更（文件<->符号链接等）
    Typechange,
    /// 未合并（冲突状态）
    Unmerged,
    /// 已忽略
    Ignored,
}

impl FileStatus {
    /// 获取状态的单字符表示
    pub fn to_char(&self) -> char {
        match self {
            FileStatus::Untracked => '?',
            FileStatus::Added => 'A',
            FileStatus::Modified => 'M',
            FileStatus::Deleted => 'D',
            FileStatus::Renamed => 'R',
            FileStatus::Typechange => 'T',
            FileStatus::Unmerged => 'U',
            FileStatus::Ignored => '!',
        }
    }

    /// 获取状态的描述文本
    pub fn description(&self) -> &'static str {
        match self {
            FileStatus::Untracked => "Untracked",
            FileStatus::Added => "Added",
            FileStatus::Modified => "Modified",
            FileStatus::Deleted => "Deleted",
            FileStatus::Renamed => "Renamed",
            FileStatus::Typechange => "Type changed",
            FileStatus::Unmerged => "Unmerged",
            FileStatus::Ignored => "Ignored",
        }
    }

    /// 判断是否为暂存状态
    pub fn is_staged(&self) -> bool {
        matches!(self, FileStatus::Added | FileStatus::Modified | FileStatus::Deleted | FileStatus::Renamed)
    }

    /// 判断是否需要用户关注
    pub fn needs_attention(&self) -> bool {
        !matches!(self, FileStatus::Ignored)
    }
}

/// 文件变更信息
#[derive(Debug, Clone, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub struct FileChange {
    /// 文件路径
    pub path: String,
    /// 变更状态
    pub status: FileStatus,
    /// 新增行数
    pub additions: usize,
    /// 删除行数
    pub deletions: usize,
    /// 旧文件路径（用于重命名）
    pub old_path: Option<String>,
}

impl FileChange {
    pub fn new(path: String, status: FileStatus) -> Self {
        Self {
            path,
            status,
            additions: 0,
            deletions: 0,
            old_path: None,
        }
    }

    pub fn with_stats(mut self, additions: usize, deletions: usize) -> Self {
        self.additions = additions;
        self.deletions = deletions;
        self
    }

    pub fn with_old_path(mut self, old_path: String) -> Self {
        self.old_path = Some(old_path);
        self
    }

    /// 获取变更总行数
    pub fn total_changes(&self) -> usize {
        self.additions + self.deletions
    }

    /// 获取净变更行数
    pub fn net_changes(&self) -> i32 {
        self.additions as i32 - self.deletions as i32
    }
}

/// 文件变更集合
#[derive(Debug, Clone, Default, Serialize, Deserialize)]
pub struct FileChanges {
    pub changes: Vec<FileChange>,
}

impl FileChanges {
    pub fn new(changes: Vec<FileChange>) -> Self {
        Self { changes }
    }

    pub fn is_empty(&self) -> bool {
        self.changes.is_empty()
    }

    pub fn len(&self) -> usize {
        self.changes.len()
    }

    /// 按状态过滤文件
    pub fn filter_by_status(&self, status: FileStatus) -> Vec<&FileChange> {
        self.changes.iter().filter(|c| c.status == status).collect()
    }

    /// 获取暂存的文件
    pub fn staged_files(&self) -> Vec<&FileChange> {
        self.changes.iter().filter(|c| c.status.is_staged()).collect()
    }

    /// 获取未暂存的文件
    pub fn unstaged_files(&self) -> Vec<&FileChange> {
        self.changes.iter().filter(|c| !c.status.is_staged() && c.status.needs_attention()).collect()
    }

    /// 计算总的变更统计
    pub fn total_stats(&self) -> (usize, usize) {
        self.changes.iter().fold((0, 0), |(add, del), change| {
            (add + change.additions, del + change.deletions)
        })
    }
}

impl std::ops::Deref for FileChanges {
    type Target = Vec<FileChange>;

    fn deref(&self) -> &Self::Target {
        &self.changes
    }
}

impl std::ops::DerefMut for FileChanges {
    fn deref_mut(&mut self) -> &mut Self::Target {
        &mut self.changes
    }
}

impl From<Vec<FileChange>> for FileChanges {
    fn from(changes: Vec<FileChange>) -> Self {
        Self::new(changes)
    }
}
```

### 1.2 Git提交相关类型

```rust
/// Git提交信息
#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
pub struct CommitInfo {
    /// 提交SHA
    pub id: String,
    /// 提交消息
    pub message: String,
    /// 作者信息
    pub author: AuthorInfo,
    /// 提交者信息
    pub committer: AuthorInfo,
    /// 提交时间
    pub timestamp: SystemTime,
    /// 父提交
    pub parents: Vec<String>,
    /// 变更的文件
    pub files: Vec<FileChange>,
}

/// 作者/提交者信息
#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
pub struct AuthorInfo {
    /// 姓名
    pub name: String,
    /// 邮箱
    pub email: String,
    /// 时间
    pub timestamp: SystemTime,
}

/// 分支信息
#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
pub struct BranchInfo {
    /// 当前分支名
    pub current_branch: String,
    /// 是否有未提交的变更
    pub has_uncommitted_changes: bool,
    /// 领先远程分支的提交数
    pub ahead: Option<usize>,
    /// 落后远程分支的提交数
    pub behind: Option<usize>,
    /// 远程跟踪分支
    pub upstream: Option<String>,
}

/// 标签信息
#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
pub struct TagInfo {
    /// 标签名称
    pub name: String,
    /// 标签消息
    pub message: Option<String>,
    /// 目标提交
    pub target: String,
    /// 创建时间
    pub created_at: SystemTime,
    /// 标签类型
    pub tag_type: TagType,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
pub enum TagType {
    Lightweight,
    Annotated,
}

/// 远程仓库信息
#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]
pub struct RemoteInfo {
    /// 远程名称
    pub name: String,
    /// 远程URL
    pub url: String,
    /// 是否可推送
    pub push_url: Option<String>,
}
```

## 2. 应用状态和UI相关类型

### 2.1 应用状态定义

```rust
use std::collections::HashMap;

/// 应用主状态
#[derive(Debug, Clone)]
pub struct AppState {
    /// 当前选中的标签页
    pub current_tab: TabState,
    /// 当前选中的文件
    pub selected_file: Option<FileItem>,
    /// 文件状态列表
    pub file_status: Vec<FileItem>,
    /// 提交历史
    pub commit_history: Vec<CommitInfo>,
    /// 分支信息
    pub branch_info: Option<BranchInfo>,
    /// 模态框栈
    pub modal_stack: Vec<Modal>,
    /// 搜索状态
    pub search_state: SearchState,
    /// 用户偏好设置
    pub preferences: UserPreferences,
    /// 临时状态
    pub temp_data: HashMap<String, serde_json::Value>,
}

/// 标签页状态
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum TabState {
    Status,
    History,
    Branches,
    Tags,
    Remotes,
    Stash,
}

impl TabState {
    /// 获取标签页名称
    pub fn name(&self) -> &'static str {
        match self {
            TabState::Status => "Status",
            TabState::History => "History",
            TabState::Branches => "Branches",
            TabState::Tags => "Tags",
            TabState::Remotes => "Remotes",
            TabState::Stash => "Stash",
        }
    }

    /// 获取所有标签页
    pub fn all() -> &'static [TabState] {
        &[
            TabState::Status,
            TabState::History,
            TabState::Branches,
            TabState::Tags,
            TabState::Remotes,
            TabState::Stash,
        ]
    }

    /// 获取下一个标签页
    pub fn next(&self) -> TabState {
        let all = Self::all();
        let current_index = all.iter().position(|&tab| tab == *self).unwrap_or(0);
        all.get(current_index + 1).copied().unwrap_or(all[0])
    }

    /// 获取上一个标签页
    pub fn prev(&self) -> TabState {
        let all = Self::all();
        let current_index = all.iter().position(|&tab| tab == *self).unwrap_or(0);
        if current_index == 0 {
            all[all.len() - 1]
        } else {
            all[current_index - 1]
        }
    }
}

/// 文件列表项
#[derive(Debug, Clone, PartialEq, Eq)]
pub struct FileItem {
    /// 文件路径
    pub path: String,
    /// 文件状态
    pub status: FileStatus,
    /// 是否被选中
    pub selected: bool,
    /// 变更统计
    pub additions: usize,
    pub deletions: usize,
}

impl FileItem {
    pub fn new(path: String, status: FileStatus) -> Self {
        Self {
            path,
            status,
            selected: false,
            additions: 0,
            deletions: 0,
        }
    }

    pub fn with_stats(mut self, additions: usize, deletions: usize) -> Self {
        self.additions = additions;
        self.deletions = deletions;
        self
    }
}

impl From<FileChange> for FileItem {
    fn from(change: FileChange) -> Self {
        Self::new(change.path, change.status)
            .with_stats(change.additions, change.deletions)
    }
}

/// 模态框类型
#[derive(Debug, Clone, PartialEq, Eq)]
pub enum Modal {
    /// 确认对话框
    Confirm {
        title: String,
        message: String,
        callback: ModalCallback,
    },
    /// 输入对话框
    Input {
        title: String,
        prompt: String,
        default_value: String,
        callback: ModalCallback,
    },
    /// 错误提示
    Error {
        title: String,
        message: String,
    },
    /// AI建议显示
    AISuggestions {
        suggestions: Vec<AISuggestion>,
        selected_index: usize,
    },
    /// 帮助文档
    Help {
        content: String,
    },
}

/// 模态框回调类型
#[derive(Debug, Clone, PartialEq, Eq)]
pub enum ModalCallback {
    Commit,
    Discard,
    DeleteBranch(String),
    CreateTag(String),
    Custom(String),
}

/// 搜索状态
#[derive(Debug, Clone, Default)]
pub struct SearchState {
    /// 搜索查询
    pub query: String,
    /// 搜索结果
    pub results: Vec<SearchResult>,
    /// 当前选中的结果索引
    pub selected_index: usize,
    /// 搜索过滤器
    pub filters: SearchFilters,
    /// 是否显示搜索框
    pub visible: bool,
}

/// 搜索结果
#[derive(Debug, Clone, PartialEq, Eq)]
pub struct SearchResult {
    /// 结果类型
    pub result_type: SearchResultType,
    /// 匹配的内容
    pub content: String,
    /// 文件路径（如果适用）
    pub file_path: Option<String>,
    /// 行号（如果适用）
    pub line_number: Option<usize>,
    /// 匹配的位置
    pub matches: Vec<SearchMatch>,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum SearchResultType {
    FileName,
    FileContent,
    CommitMessage,
    BranchName,
    TagName,
}

#[derive(Debug, Clone, PartialEq, Eq)]
pub struct SearchMatch {
    /// 匹配开始位置
    pub start: usize,
    /// 匹配结束位置
    pub end: usize,
    /// 匹配的文本
    pub text: String,
}

/// 搜索过滤器
#[derive(Debug, Clone, Default)]
pub struct SearchFilters {
    /// 文件类型过滤
    pub file_extensions: Vec<String>,
    /// 是否包含已忽略的文件
    pub include_ignored: bool,
    /// 搜索范围
    pub scope: SearchScope,
    /// 是否使用正则表达式
    pub use_regex: bool,
    /// 是否大小写敏感
    pub case_sensitive: bool,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum SearchScope {
    CurrentBranch,
    AllBranches,
    WorkingDirectory,
    StagedFiles,
}

/// 用户偏好设置
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UserPreferences {
    /// 主题名称
    pub theme: String,
    /// 语言设置
    pub language: String,
    /// 键盘绑定方案
    pub key_bindings: String,
    /// 是否启用AI功能
    pub ai_enabled: bool,
    /// AI服务配置
    pub ai_config: AIConfig,
    /// UI设置
    pub ui_settings: UISettings,
    /// Git设置
    pub git_settings: GitSettings,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UISettings {
    /// 是否显示行号
    pub show_line_numbers: bool,
    /// 是否启用语法高亮
    pub syntax_highlighting: bool,
    /// 字体大小
    pub font_size: u16,
    /// 是否显示空白字符
    pub show_whitespace: bool,
    /// 差异显示模式
    pub diff_mode: DiffMode,
    /// 文件列表排序
    pub file_sort_mode: FileSortMode,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
pub enum DiffMode {
    Unified,
    SideBySide,
    Inline,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
pub enum FileSortMode {
    Name,
    Status,
    Modified,
    Size,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct GitSettings {
    /// 默认提交消息模板
    pub commit_template: String,
    /// 是否自动暂存
    pub auto_stage: bool,
    /// 是否启用GPG签名
    pub gpg_sign: bool,
    /// 推送行为
    pub push_behavior: PushBehavior,
    /// 合并策略
    pub merge_strategy: MergeStrategy,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
pub enum PushBehavior {
    Simple,
    Matching,
    Upstream,
    Current,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
pub enum MergeStrategy {
    Merge,
    Rebase,
    RebaseInteractive,
}
```

## 3. AI和Agent相关类型

### 3.1 AI配置和建议类型

```rust
/// AI服务配置
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AIConfig {
    /// API基础URL
    pub api_url: String,
    /// API密钥
    pub api_key: String,
    /// 使用的模型
    pub model: String,
    /// 最大令牌数
    pub max_tokens: u32,
    /// 温度参数
    pub temperature: f64,
    /// 超时设置
    pub timeout: std::time::Duration,
    /// 重试次数
    pub retry_count: u8,
    /// 提示词模板
    pub prompt_templates: HashMap<String, String>,
}

impl Default for AIConfig {
    fn default() -> Self {
        Self {
            api_url: "https://api.openai.com/v1".to_string(),
            api_key: String::new(),
            model: "gpt-3.5-turbo".to_string(),
            max_tokens: 150,
            temperature: 0.7,
            timeout: std::time::Duration::from_secs(30),
            retry_count: 3,
            prompt_templates: HashMap::new(),
        }
    }
}

/// AI提交消息建议
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct AISuggestion {
    /// 建议的提交消息
    pub message: String,
    /// 置信度分数 (0.0 - 1.0)
    pub confidence: f64,
    /// 消息类别
    pub category: CommitCategory,
    /// 详细描述
    pub description: Option<String>,
    /// 相关文件
    pub related_files: Vec<String>,
}

/// 提交消息类别
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]
pub enum CommitCategory {
    Feature,
    Fix,
    Documentation,
    Style,
    Refactor,
    Performance,
    Test,
    Build,
    CI,
    Chore,
    Revert,
}

impl CommitCategory {
    /// 获取类别的前缀
    pub fn prefix(&self) -> &'static str {
        match self {
            CommitCategory::Feature => "feat",
            CommitCategory::Fix => "fix",
            CommitCategory::Documentation => "docs",
            CommitCategory::Style => "style",
            CommitCategory::Refactor => "refactor",
            CommitCategory::Performance => "perf",
            CommitCategory::Test => "test",
            CommitCategory::Build => "build",
            CommitCategory::CI => "ci",
            CommitCategory::Chore => "chore",
            CommitCategory::Revert => "revert",
        }
    }

    /// 获取类别描述
    pub fn description(&self) -> &'static str {
        match self {
            CommitCategory::Feature => "A new feature",
            CommitCategory::Fix => "A bug fix",
            CommitCategory::Documentation => "Documentation only changes",
            CommitCategory::Style => "Changes that do not affect the meaning of the code",
            CommitCategory::Refactor => "A code change that neither fixes a bug nor adds a feature",
            CommitCategory::Performance => "A code change that improves performance",
            CommitCategory::Test => "Adding missing tests or correcting existing tests",
            CommitCategory::Build => "Changes that affect the build system or external dependencies",
            CommitCategory::CI => "Changes to our CI configuration files and scripts",
            CommitCategory::Chore => "Other changes that don't modify src or test files",
            CommitCategory::Revert => "Reverts a previous commit",
        }
    }
}

/// 代码分析结果
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CodeAnalysisResult {
    /// 分析的文件
    pub file_path: String,
    /// 代码复杂度
    pub complexity: ComplexityMetrics,
    /// 潜在问题
    pub issues: Vec<CodeIssue>,
    /// 建议改进
    pub suggestions: Vec<String>,
    /// 代码质量评分 (0-100)
    pub quality_score: u8,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ComplexityMetrics {
    /// 圈复杂度
    pub cyclomatic: u32,
    /// 代码行数
    pub lines_of_code: u32,
    /// 函数数量
    pub function_count: u32,
    /// 嵌套深度
    pub nesting_depth: u32,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CodeIssue {
    /// 问题类型
    pub issue_type: IssueType,
    /// 问题描述
    pub description: String,
    /// 严重程度
    pub severity: IssueSeverity,
    /// 位置信息
    pub location: Option<IssueLocation>,
    /// 修复建议
    pub fix_suggestion: Option<String>,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
pub enum IssueType {
    Performance,
    Security,
    Maintainability,
    Style,
    Bug,
    Smell,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Serialize, Deserialize)]
pub enum IssueSeverity {
    Low,
    Medium,
    High,
    Critical,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct IssueLocation {
    /// 文件路径
    pub file: String,
    /// 起始行号
    pub start_line: u32,
    /// 结束行号
    pub end_line: u32,
    /// 起始列号
    pub start_column: Option<u32>,
    /// 结束列号
    pub end_column: Option<u32>,
}
```

### 3.2 任务和事件类型

```rust
/// 应用事件
#[derive(Debug, Clone, PartialEq, Eq)]
pub enum AppEvent {
    /// 键盘事件
    Key(crossterm::event::KeyEvent),
    /// 鼠标事件
    Mouse(crossterm::event::MouseEvent),
    /// 窗口大小变更
    Resize(u16, u16),
    /// Git状态更新
    GitStatusUpdated(Vec<FileItem>),
    /// AI建议生成完成
    AISuggestionsReady(Vec<AISuggestion>),
    /// 错误发生
    Error(String),
    /// 信息通知
    Info(String),
    /// 任务完成
    TaskCompleted(String),
    /// 文件系统变更
    FileSystemChanged(Vec<String>),
}

/// 用户动作
#[derive(Debug, Clone, PartialEq, Eq)]
pub enum Action {
    /// 切换标签页
    SwitchTab(TabState),
    /// 选择文件
    SelectFile(FileItem),
    /// 暂存文件
    StageFile(String),
    /// 取消暂存文件
    UnstageFile(String),
    /// 提交变更
    Commit(String),
    /// 生成AI建议
    GenerateAISuggestions,
    /// 应用AI建议
    ApplyAISuggestion(usize),
    /// 刷新状态
    RefreshStatus,
    /// 搜索
    Search(String),
    /// 清除搜索
    ClearSearch,
    /// 显示模态框
    ShowModal(Modal),
    /// 关闭模态框
    CloseModal,
    /// 退出应用
    Quit,
}

/// 异步任务类型
#[derive(Debug, Clone, PartialEq, Eq)]
pub enum AsyncTask {
    /// 获取Git状态
    GetGitStatus,
    /// 生成AI建议
    GenerateAISuggestions(FileChanges),
    /// 执行Git命令
    GitCommand(GitCommand),
    /// 保存配置
    SaveConfig(UserPreferences),
    /// 加载配置
    LoadConfig,
    /// 检查更新
    CheckUpdate,
}

#[derive(Debug, Clone, PartialEq, Eq)]
pub enum GitCommand {
    Add(Vec<String>),
    Remove(Vec<String>),
    Commit(String),
    Push,
    Pull,
    Fetch,
    Checkout(String),
    CreateBranch(String),
    DeleteBranch(String),
    CreateTag(String, Option<String>),
    DeleteTag(String),
}

/// 任务结果
#[derive(Debug, Clone)]
pub enum TaskResult {
    GitStatus(Result<Vec<FileItem>, String>),
    AISuggestions(Result<Vec<AISuggestion>, String>),
    GitOperation(Result<String, String>),
    ConfigOperation(Result<(), String>),
    UpdateCheck(Result<Option<String>, String>),
}
```

## 4. 错误处理和结果类型

### 4.1 统一错误类型

```rust
use thiserror::Error;

/// 应用主错误类型
#[derive(Error, Debug)]
pub enum AppError {
    #[error("Git error: {0}")]
    Git(#[from] GitError),

    #[error("AI service error: {0}")]
    AI(#[from] AIError),

    #[error("IO error: {0}")]
    Io(#[from] std::io::Error),

    #[error("Serialization error: {0}")]
    Serialization(#[from] serde_json::Error),

    #[error("Configuration error: {0}")]
    Config(String),

    #[error("UI error: {0}")]
    UI(String),

    #[error("Network error: {0}")]
    Network(String),

    #[error("Permission denied: {0}")]
    Permission(String),

    #[error("Resource not found: {0}")]
    NotFound(String),

    #[error("Operation cancelled")]
    Cancelled,

    #[error("Timeout occurred")]
    Timeout,

    #[error("Internal error: {0}")]
    Internal(String),
}

/// Git相关错误
#[derive(Error, Debug)]
pub enum GitError {
    #[error("Repository not found at {path}")]
    RepositoryNotFound { path: String },

    #[error("Not a git repository")]
    NotARepository,

    #[error("Git command failed: {0}")]
    CommandFailed(String),

    #[error("Working directory is dirty")]
    DirtyWorkingDirectory,

    #[error("Branch '{0}' not found")]
    BranchNotFound(String),

    #[error("Merge conflict in {0}")]
    MergeConflict(String),

    #[error("Nothing to commit")]
    NothingToCommit,

    #[error("Authentication required")]
    AuthenticationRequired,

    #[error("Permission denied")]
    PermissionDenied,

    #[error("Network error: {0}")]
    NetworkError(String),
}

/// AI服务错误
#[derive(Error, Debug)]
pub enum AIError {
    #[error("API request failed: {0}")]
    ApiRequestFailed(String),

    #[error("Authentication failed")]
    AuthenticationFailed,

    #[error("Rate limit exceeded")]
    RateLimitExceeded,

    #[error("Invalid response format")]
    InvalidResponse,

    #[error("Model not available: {0}")]
    ModelNotAvailable(String),

    #[error("Token limit exceeded")]
    TokenLimitExceeded,

    #[error("Service unavailable")]
    ServiceUnavailable,

    #[error("Timeout")]
    Timeout,
}

/// 结果类型别名
pub type AppResult<T> = Result<T, AppError>;
pub type GitResult<T> = Result<T, GitError>;
pub type AIResult<T> = Result<T, AIError>;
```

### 4.2 配置和验证类型

```rust
/// 配置验证错误
#[derive(Error, Debug)]
pub enum ValidationError {
    #[error("Required field '{field}' is missing")]
    MissingField { field: String },

    #[error("Invalid value for '{field}': {value}")]
    InvalidValue { field: String, value: String },

    #[error("Value out of range for '{field}': {value} (expected: {range})")]
    OutOfRange { field: String, value: String, range: String },

    #[error("Invalid format for '{field}': {reason}")]
    InvalidFormat { field: String, reason: String },
}

/// 配置验证器trait
pub trait Validator {
    fn validate(&self) -> Result<(), Vec<ValidationError>>;
}

impl Validator for AIConfig {
    fn validate(&self) -> Result<(), Vec<ValidationError>> {
        let mut errors = Vec::new();

        if self.api_key.is_empty() {
            errors.push(ValidationError::MissingField {
                field: "api_key".to_string(),
            });
        }

        if self.max_tokens == 0 || self.max_tokens > 4096 {
            errors.push(ValidationError::OutOfRange {
                field: "max_tokens".to_string(),
                value: self.max_tokens.to_string(),
                range: "1-4096".to_string(),
            });
        }

        if self.temperature < 0.0 || self.temperature > 2.0 {
            errors.push(ValidationError::OutOfRange {
                field: "temperature".to_string(),
                value: self.temperature.to_string(),
                range: "0.0-2.0".to_string(),
            });
        }

        if !self.api_url.starts_with("http") {
            errors.push(ValidationError::InvalidFormat {
                field: "api_url".to_string(),
                reason: "Must start with http or https".to_string(),
            });
        }

        if errors.is_empty() {
            Ok(())
        } else {
            Err(errors)
        }
    }
}

impl Validator for UserPreferences {
    fn validate(&self) -> Result<(), Vec<ValidationError>> {
        let mut errors = Vec::new();

        // 验证AI配置
        if let Err(ai_errors) = self.ai_config.validate() {
            errors.extend(ai_errors);
        }

        // 验证UI设置
        if self.ui_settings.font_size < 8 || self.ui_settings.font_size > 32 {
            errors.push(ValidationError::OutOfRange {
                field: "ui_settings.font_size".to_string(),
                value: self.ui_settings.font_size.to_string(),
                range: "8-32".to_string(),
            });
        }

        if errors.is_empty() {
            Ok(())
        } else {
            Err(errors)
        }
    }
}
```

## 5. 常量和默认值

### 5.1 应用常量

```rust
/// 应用常量
pub mod constants {
    use std::time::Duration;

    /// 应用名称
    pub const APP_NAME: &str = "AI-Commit";

    /// 应用版本
    pub const APP_VERSION: &str = env!("CARGO_PKG_VERSION");

    /// 配置文件名
    pub const CONFIG_FILE_NAME: &str = "ai-commit.toml";

    /// 日志文件名
    pub const LOG_FILE_NAME: &str = "ai-commit.log";

    /// 默认主题
    pub const DEFAULT_THEME: &str = "default";

    /// 支持的文件扩展名
    pub const SUPPORTED_EXTENSIONS: &[&str] = &[
        "rs", "js", "ts", "py", "go", "java", "cpp", "c", "h",
        "html", "css", "scss", "vue", "jsx", "tsx", "md", "json",
        "yaml", "yml", "toml", "xml", "sql", "sh", "bat", "ps1"
    ];

    /// UI相关常量
    pub mod ui {
        /// 最小窗口宽度
        pub const MIN_WINDOW_WIDTH: u16 = 80;

        /// 最小窗口高度
        pub const MIN_WINDOW_HEIGHT: u16 = 24;

        /// 状态栏高度
        pub const STATUS_BAR_HEIGHT: u16 = 1;

        /// 标签页栏高度
        pub const TAB_BAR_HEIGHT: u16 = 3;

        /// 侧边栏最小宽度
        pub const SIDEBAR_MIN_WIDTH: u16 = 30;

        /// 模态框最大宽度
        pub const MODAL_MAX_WIDTH: u16 = 60;

        /// 模态框最大高度
        pub const MODAL_MAX_HEIGHT: u16 = 20;
    }

    /// 性能相关常量
    pub mod performance {
        /// UI刷新间隔
        pub const UI_REFRESH_INTERVAL: Duration = Duration::from_millis(16); // ~60 FPS

        /// Git状态检查间隔
        pub const GIT_STATUS_CHECK_INTERVAL: Duration = Duration::from_secs(1);

        /// AI建议缓存时间
        pub const AI_SUGGESTION_CACHE_TTL: Duration = Duration::from_secs(300);

        /// 最大文件显示数量
        pub const MAX_DISPLAYED_FILES: usize = 1000;

        /// 最大提交历史数量
        pub const MAX_COMMIT_HISTORY: usize = 100;

        /// 最大搜索结果数量
        pub const MAX_SEARCH_RESULTS: usize = 500;
    }

    /// 网络相关常量
    pub mod network {
        /// HTTP请求超时
        pub const HTTP_TIMEOUT: Duration = Duration::from_secs(30);

        /// 重试次数
        pub const MAX_RETRIES: u8 = 3;

        /// 重试间隔
        pub const RETRY_INTERVAL: Duration = Duration::from_millis(1000);
    }
}

/// 默认配置
pub mod defaults {
    use super::*;
    use crate::constants;

    impl Default for AppState {
        fn default() -> Self {
            Self {
                current_tab: TabState::Status,
                selected_file: None,
                file_status: Vec::new(),
                commit_history: Vec::new(),
                branch_info: None,
                modal_stack: Vec::new(),
                search_state: SearchState::default(),
                preferences: UserPreferences::default(),
                temp_data: HashMap::new(),
            }
        }
    }

    impl Default for UserPreferences {
        fn default() -> Self {
            Self {
                theme: constants::DEFAULT_THEME.to_string(),
                language: "en".to_string(),
                key_bindings: "default".to_string(),
                ai_enabled: true,
                ai_config: AIConfig::default(),
                ui_settings: UISettings::default(),
                git_settings: GitSettings::default(),
            }
        }
    }

    impl Default for UISettings {
        fn default() -> Self {
            Self {
                show_line_numbers: true,
                syntax_highlighting: true,
                font_size: 14,
                show_whitespace: false,
                diff_mode: DiffMode::Unified,
                file_sort_mode: FileSortMode::Status,
            }
        }
    }

    impl Default for GitSettings {
        fn default() -> Self {
            Self {
                commit_template: String::new(),
                auto_stage: false,
                gpg_sign: false,
                push_behavior: PushBehavior::Simple,
                merge_strategy: MergeStrategy::Merge,
            }
        }
    }
}
```

## 6. 工具函数和扩展

### 6.1 字符串扩展

```rust
/// 字符串工具扩展
pub trait StringExt {
    fn truncate_with_ellipsis(&self, max_len: usize) -> String;
    fn highlight_matches(&self, query: &str) -> String;
    fn to_commit_case(&self) -> String;
    fn is_commit_message_valid(&self) -> bool;
}

impl StringExt for String {
    fn truncate_with_ellipsis(&self, max_len: usize) -> String {
        if self.len() <= max_len {
            self.clone()
        } else {
            format!("{}...", &self[..max_len.saturating_sub(3)])
        }
    }

    fn highlight_matches(&self, query: &str) -> String {
        if query.is_empty() {
            return self.clone();
        }

        // 简单的高亮实现，在实际使用中可能需要更复杂的逻辑
        self.replace(query, &format!("**{}**", query))
    }

    fn to_commit_case(&self) -> String {
        if self.is_empty() {
            return self.clone();
        }

        let first_char = self.chars().next().unwrap();
        if first_char.is_uppercase() {
            self.clone()
        } else {
            format!("{}{}", first_char.to_uppercase(), &self[1..])
        }
    }

    fn is_commit_message_valid(&self) -> bool {
        !self.trim().is_empty() && self.len() <= 50 // 简单验证
    }
}

impl StringExt for str {
    fn truncate_with_ellipsis(&self, max_len: usize) -> String {
        self.to_string().truncate_with_ellipsis(max_len)
    }

    fn highlight_matches(&self, query: &str) -> String {
        self.to_string().highlight_matches(query)
    }

    fn to_commit_case(&self) -> String {
        self.to_string().to_commit_case()
    }

    fn is_commit_message_valid(&self) -> bool {
        self.to_string().is_commit_message_valid()
    }
}
```

### 6.2 时间工具

```rust
/// 时间工具函数
pub mod time_utils {
    use std::time::{SystemTime, Duration};

    /// 格式化相对时间
    pub fn format_relative_time(time: SystemTime) -> String {
        let now = SystemTime::now();
        let duration = now.duration_since(time).unwrap_or(Duration::ZERO);

        let seconds = duration.as_secs();

        match seconds {
            0..=59 => "just now".to_string(),
            60..=3599 => format!("{} minutes ago", seconds / 60),
            3600..=86399 => format!("{} hours ago", seconds / 3600),
            86400..=2591999 => format!("{} days ago", seconds / 86400),
            _ => format!("{} months ago", seconds / 2592000),
        }
    }

    /// 格式化持续时间
    pub fn format_duration(duration: Duration) -> String {
        let total_seconds = duration.as_secs();
        let milliseconds = duration.subsec_millis();

        if total_seconds == 0 {
            format!("{}ms", milliseconds)
        } else if total_seconds < 60 {
            format!("{}.{:03}s", total_seconds, milliseconds)
        } else if total_seconds < 3600 {
            format!("{}m{}s", total_seconds / 60, total_seconds % 60)
        } else {
            format!("{}h{}m", total_seconds / 3600, (total_seconds % 3600) / 60)
        }
    }

    /// 格式化绝对时间
    pub fn format_absolute_time(time: SystemTime) -> String {
        // 这里需要使用chrono或类似的库来格式化时间
        // 为了保持简单，这里返回调试格式
        format!("{:?}", time)
    }
}
```

### 6.3 文件工具

```rust
/// 文件工具函数
pub mod file_utils {
    use std::path::{Path, PathBuf};

    /// 获取文件扩展名
    pub fn get_file_extension(path: &str) -> Option<String> {
        Path::new(path)
            .extension()
            .and_then(|ext| ext.to_str())
            .map(|ext| ext.to_lowercase())
    }

    /// 获取文件名（不包含路径）
    pub fn get_file_name(path: &str) -> String {
        Path::new(path)
            .file_name()
            .and_then(|name| name.to_str())
            .unwrap_or(path)
            .to_string()
    }

    /// 获取文件的父目录
    pub fn get_parent_dir(path: &str) -> Option<String> {
        Path::new(path)
            .parent()
            .and_then(|parent| parent.to_str())
            .map(|s| s.to_string())
    }

    /// 判断是否为支持的文件类型
    pub fn is_supported_file(path: &str) -> bool {
        if let Some(ext) = get_file_extension(path) {
            crate::constants::SUPPORTED_EXTENSIONS.contains(&ext.as_str())
        } else {
            false
        }
    }

    /// 标准化路径
    pub fn normalize_path(path: &str) -> String {
        Path::new(path)
            .components()
            .collect::<PathBuf>()
            .to_string_lossy()
            .to_string()
    }

    /// 计算相对路径
    pub fn relative_path(base: &str, target: &str) -> Option<String> {
        let base_path = Path::new(base);
        let target_path = Path::new(target);

        target_path
            .strip_prefix(base_path)
            .ok()
            .and_then(|p| p.to_str())
            .map(|s| s.to_string())
    }
}
```

这个核心接口和数据结构定义文档提供了AI-Commit TUI项目所需的全部基础类型定义，包括：

1. **Git相关类型**: 文件状态、变更信息、提交数据、分支和标签信息
2. **应用状态类型**: 主应用状态、UI状态、搜索状态、用户偏好
3. **AI相关类型**: AI配置、建议结果、代码分析结果
4. **事件和任务类型**: 应用事件、用户动作、异步任务
5. **错误处理类型**: 统一的错误类型和验证框架
6. **常量和默认值**: 应用常量、默认配置
7. **工具函数**: 字符串扩展、时间工具、文件工具

这些定义为整个项目提供了坚实的类型基础，确保代码的类型安全性和一致性。